<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:cp="clr-namespace:Avalonia.Controls;assembly=Avalonia.Controls.ColorPicker"
        xmlns:local="clr-namespace:CherryKeyLayout.Gui.Converters"
        x:Class="CherryKeyLayout.Gui.MainWindow"
        x:Name="RootWindow"
        Title="Cherry Key Layout"
        Width="1100"
        Height="680"
        MinWidth="980"
        MinHeight="600"
        ExtendClientAreaToDecorationsHint="True">
  <Window.Resources>
    <local:BoolToThicknessConverter x:Key="BoolToThickness" />
    <local:HandleRightConverter x:Key="HandleRight" />
    <local:HandleBottomConverter x:Key="HandleBottom" />
  </Window.Resources>
  <Grid RowDefinitions="Auto,*,Auto" Margin="18">
    <Grid Height="28" ColumnDefinitions="Auto,*" Background="Transparent">
      <Button Classes="ghost"
              Width="28"
              Height="28"
              Padding="0"
              HorizontalContentAlignment="Center"
              VerticalContentAlignment="Center"
              HorizontalAlignment="Left"
              VerticalAlignment="Center">
        <Button.Flyout>
          <MenuFlyout>
            <MenuItem Header="Device" Command="{Binding SelectDeviceTabCommand}" />
            <MenuItem Header="Settings" Command="{Binding SelectSettingsTabCommand}" />
          </MenuFlyout>
        </Button.Flyout>
        <Path Width="14"
              Height="12"
              Stretch="Uniform"
              HorizontalAlignment="Center"
              VerticalAlignment="Center"
              Stroke="{DynamicResource TextMutedBrush}"
              StrokeThickness="2"
              StrokeLineCap="Round"
              Data="M3,5 L21,5 M3,11 L21,11 M3,17 L21,17" />
      </Button>
      <Border Grid.Column="1"
              Background="Transparent"
              PointerPressed="OnDragPointerPressed" />
    </Grid>
    <TabControl Grid.Row="1" TabStripPlacement="Left" SelectedIndex="{Binding SelectedTabIndex}">
      <TabItem Header="Device" Classes="menuOnlyTab">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
          <Grid ColumnDefinitions="280,*" RowDefinitions="Auto,*" Margin="0">
          <Border Classes="card" Grid.RowSpan="2">
            <StackPanel Spacing="10">
              <TextBlock Text="Devices" Classes="section" />
              <ListBox ItemsSource="{Binding Devices}"
                       SelectedItem="{Binding SelectedDevice}"
                       Background="Transparent"
                       BorderThickness="0"
                       Margin="0,4,0,8">
                <ListBox.Styles>
                  <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                  </Style>
                  <Style Selector="ListBoxItem:selected">
                    <Setter Property="Background" Value="Transparent" />
                  </Style>
                  <Style Selector="ListBoxItem:pointerover Border.deviceIndicator">
                    <Setter Property="Background" Value="{DynamicResource AccentSoftBrush}" />
                  </Style>
                  <Style Selector="ListBoxItem:selected Border.deviceIndicator">
                    <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                  </Style>
                </ListBox.Styles>
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Border CornerRadius="10"
                            ClipToBounds="True"
                            Margin="6,4,6,4"
                            HorizontalAlignment="Stretch">
                      <Grid ColumnDefinitions="6,*">
                        <Border Classes="deviceIndicator"
                                Background="Transparent"
                                CornerRadius="10" />
                        <Border Grid.Column="1"
                                Padding="10"
                                Background="{DynamicResource CardBrush}"
                                CornerRadius="10">
                          <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                        </Border>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
              <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Classes="ghost" Content="Add" Command="{Binding AddDeviceCommand}" />
                <Button Classes="ghost" Content="Remove" Command="{Binding RemoveDeviceCommand}" />
              </StackPanel>
            </StackPanel>
          </Border>

          <Border Classes="card" Grid.Column="1" Margin="18,0,0,0">
            <StackPanel Spacing="10">
              <TextBlock Text="Device Setup" Classes="section" />
              <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="Name" VerticalAlignment="Center" />
                <TextBox Width="260" Text="{Binding DeviceName}" />
                <Button Classes="ghost" Content="Load Keyboard Image" Click="OnLoadKeyboardImageClicked" />
                <Button Classes="ghost" Content="Load Key Layout" Click="OnLoadKeyboardLayoutClicked" />
                <Button Classes="ghost" Content="Save Layout" Click="OnSaveKeyboardLayoutClicked" IsEnabled="{Binding IsLayoutReady}" />
              </StackPanel>
              <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="Layout Template" VerticalAlignment="Center" />
                <ComboBox Width="140"
                          ItemsSource="{Binding KeyboardLayoutTemplates}"
                          SelectedItem="{Binding SelectedLayoutTemplate}" />
                <Button Classes="ghost" Content="Generate from Template" Command="{Binding GenerateFromTemplateCommand}" />
                <TextBlock Text="or" VerticalAlignment="Center" Foreground="{DynamicResource TextMutedBrush}" />
                <TextBlock Text="Grid" VerticalAlignment="Center" />
                <TextBox Width="60" Text="{Binding LayoutColumnsText}" Watermark="Cols" />
                <TextBox Width="60" Text="{Binding LayoutRowsText}" Watermark="Rows" />
                <Button Classes="ghost" Content="Generate Grid" Command="{Binding GenerateLayoutCommand}" />
              </StackPanel>
              <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="ðŸ’¡ Drag keys to reposition them on the canvas. Ctrl+wheel scales key size. Colors are applied via Profiles, not here."
                           Foreground="{DynamicResource TextMutedBrush}"
                           VerticalAlignment="Center" />
              </StackPanel>
            </StackPanel>
          </Border>

          <Border Classes="card" Grid.Column="1" Grid.Row="1" Margin="18,18,0,0">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
              <Viewbox x:Name="KeyboardViewbox" Stretch="Uniform" StretchDirection="Both" MinWidth="400" MinHeight="200">
                <Grid Width="{Binding KeyboardCanvasWidth}" Height="{Binding KeyboardCanvasHeight}">
                  <Image Source="{Binding KeyboardImage}"
                         Width="{Binding KeyboardCanvasWidth}"
                         Height="{Binding KeyboardCanvasHeight}"
                         Stretch="Uniform" />
                  <ItemsControl x:Name="KeyboardKeys"
                                ItemsSource="{Binding KeyButtons}"
                                Width="{Binding KeyboardCanvasWidth}"
                                Height="{Binding KeyboardCanvasHeight}">
                    <ItemsControl.Styles>
                      <Style Selector="ItemsControl#KeyboardKeys > ContentPresenter">
                        <Setter Property="Canvas.Left" Value="{Binding X}" />
                        <Setter Property="Canvas.Top" Value="{Binding Y}" />
                      </Style>
                    </ItemsControl.Styles>
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <Canvas Background="Transparent" ClipToBounds="True" />
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Grid Width="{Binding Width}"
                              Height="{Binding Height}">
                          <!-- Key background -->
                          <Border Width="{Binding Width}"
                            Height="{Binding Height}"
                            Background="#40FFFFFF"
                            BorderBrush="#80FFFFFF"
                            BorderThickness="1"
                            CornerRadius="2"
                            ToolTip.Tip="{Binding Id}"
                            Cursor="Hand" />
                          <!-- Selection overlay -->
                          <Border Width="{Binding Width}"
                            Height="{Binding Height}"
                            BorderBrush="#FF00BFFF"
                            BorderThickness="{Binding IsSelected, Converter={StaticResource BoolToThickness}, ConverterParameter=2}"
                            CornerRadius="2"
                            IsHitTestVisible="False" />
                          <!-- Resize handles (corners) -->
                          <Canvas Width="{Binding Width}" Height="{Binding Height}">
                            <Rectangle Width="8" Height="8" Fill="#FF00BFFF" Cursor="SizeAll"
                                 Canvas.Left="-4" Canvas.Top="-4"
                                 IsVisible="{Binding IsSelected}"
                                 Tag="TopLeft"
                                 PointerPressed="OnResizeHandlePointerPressed" />
                            <Rectangle Width="8" Height="8" Fill="#FF00BFFF" Cursor="SizeAll"
                                 Canvas.Left="{Binding Width, Converter={StaticResource HandleRight}}" Canvas.Top="-4"
                                 IsVisible="{Binding IsSelected}"
                                 Tag="TopRight"
                                 PointerPressed="OnResizeHandlePointerPressed" />
                            <Rectangle Width="8" Height="8" Fill="#FF00BFFF" Cursor="SizeAll"
                                 Canvas.Left="-4" Canvas.Top="{Binding Height, Converter={StaticResource HandleBottom}}"
                                 IsVisible="{Binding IsSelected}"
                                 Tag="BottomLeft"
                                 PointerPressed="OnResizeHandlePointerPressed" />
                            <Rectangle Width="8" Height="8" Fill="#FF00BFFF" Cursor="SizeAll"
                                 Canvas.Left="{Binding Width, Converter={StaticResource HandleRight}}" Canvas.Top="{Binding Height, Converter={StaticResource HandleBottom}}"
                                 IsVisible="{Binding IsSelected}"
                                 Tag="BottomRight"
                                 PointerPressed="OnResizeHandlePointerPressed" />
                          </Canvas>
                        </Grid>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </Grid>
              </Viewbox>
            </ScrollViewer>
          </Border>
          </Grid>
        </ScrollViewer>
      </TabItem>

      <TabItem Header="Settings" Classes="menuOnlyTab">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
          <StackPanel Spacing="18">
            <Border Classes="card">
              <StackPanel Spacing="10">
                <TextBlock Text="Settings Load / Save" Classes="section" />
                <TextBox Text="{Binding SettingsPath}" Watermark="Path to settings.json" />
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <Button Classes="ghost" Content="Browse" Click="OnBrowseClicked" />
                  <Button Classes="ghost" Content="Reload" Command="{Binding ReloadCommand}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <ToggleSwitch IsChecked="{Binding SyncSelectedProfile}" />
                  <TextBlock Text="Sync selected profile to file" VerticalAlignment="Center" />
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

      <TabItem Header="Profiles">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
          <Grid ColumnDefinitions="280,*">
            <Border Classes="card">
            <StackPanel Spacing="10">
              <TextBlock Text="Profiles" Classes="section" />
              <TextBlock Text="{Binding ProfileCountLabel}" Foreground="{DynamicResource TextMutedBrush}" />
              <ListBox ItemsSource="{Binding Profiles}"
                       SelectedItem="{Binding SelectedProfile}"
                       Background="Transparent"
                       BorderThickness="0"
                       Margin="0,4,0,8">
                <ListBox.Styles>
                  <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                  </Style>
                  <Style Selector="ListBoxItem:selected">
                    <Setter Property="Background" Value="Transparent" />
                  </Style>
                  <Style Selector="ListBoxItem:pointerover Border.profileIndicator">
                    <Setter Property="Background" Value="{DynamicResource AccentSoftBrush}" />
                  </Style>
                  <Style Selector="ListBoxItem:selected Border.profileIndicator">
                    <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                  </Style>
                </ListBox.Styles>
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Border CornerRadius="10"
                            ClipToBounds="True"
                            Margin="6,4,6,4"
                            HorizontalAlignment="Stretch">
                      <Grid ColumnDefinitions="6,*">
                        <Border Classes="profileIndicator"
                                Background="Transparent"
                                CornerRadius="10" />
                        <Border Grid.Column="1"
                                Padding="10"
                                Background="{DynamicResource CardBrush}"
                                CornerRadius="10">
                          <StackPanel Spacing="4">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                              <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                              <Path Width="12"
                                    Height="12"
                                    Stretch="Uniform"
                                    Fill="{DynamicResource AccentBrush}"
                                    Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.45,13.97 L5.82,21 Z"
                                    IsVisible="{Binding IsDefault}" />
                            </StackPanel>
                            <TextBlock Text="{Binding AppSummary}"
                                       Foreground="{DynamicResource TextMutedBrush}"
                                       FontSize="12" />
                          </StackPanel>
                        </Border>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </StackPanel>
          </Border>

            <Border Grid.Column="1" Classes="card" Margin="18,0,0,0">
            <StackPanel Spacing="10">
              <Grid ColumnDefinitions="240,64,*,Auto" VerticalAlignment="Center">
                <TextBox Grid.Column="0"
                         Text="{Binding ProfileTitleDraft}"
                         VerticalAlignment="Center"
                         Width="240"
                         HorizontalAlignment="Left"
                         IsVisible="{Binding IsEditingProfileTitle}" />
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            Spacing="6"
                            VerticalAlignment="Center"
                            IsVisible="{Binding IsNotEditingProfileTitle}">
                  <TextBlock Text="{Binding SelectedProfileTitle}"
                             FontSize="18"
                             FontWeight="SemiBold"
                             TextTrimming="CharacterEllipsis"
                             MaxWidth="210"
                             VerticalAlignment="Center" />
                  <Button Classes="ghost"
                          Width="26"
                          Height="26"
                          Padding="0"
                          ToolTip.Tip="Edit profile name"
                          Command="{Binding StartEditProfileTitleCommand}">
                    <Path Width="14"
                          Height="14"
                          Stretch="Uniform"
                          Fill="{DynamicResource TextMutedBrush}"
                          Data="M3,17.25 L3,21 L6.75,21 L17.81,9.94 L14.06,6.19 Z M20.71,7.04 C21.1,6.65 21.1,6.02 20.71,5.63 L18.37,3.29 C17.98,2.9 17.35,2.9 16.96,3.29 L15.13,5.12 L18.88,8.87 Z" />
                  </Button>
                </StackPanel>
                <Border Grid.Column="1"
                        Width="64"
                        VerticalAlignment="Center">
                  <Grid>
                    <StackPanel Orientation="Horizontal"
                                Spacing="6"
                                HorizontalAlignment="Left"
                                IsVisible="{Binding IsEditingProfileTitle}">
                      <Button Classes="ghost"
                              Width="26"
                              Height="26"
                              Padding="0"
                              ToolTip.Tip="Confirm"
                              Command="{Binding ConfirmEditProfileTitleCommand}">
                        <Path Width="14"
                              Height="14"
                              Stretch="Uniform"
                              Fill="{DynamicResource TextMutedBrush}"
                              Data="M6,12 L10,16 L18,8 L16.6,6.6 L10,13.2 L7.4,10.6 Z" />
                      </Button>
                      <Button Classes="ghost"
                              Width="26"
                              Height="26"
                              Padding="0"
                              ToolTip.Tip="Cancel"
                              Command="{Binding CancelEditProfileTitleCommand}">
                        <Path Width="12"
                              Height="12"
                              Stretch="Uniform"
                              Stroke="{DynamicResource TextMutedBrush}"
                              StrokeThickness="2"
                              Data="M6,6 L18,18 M18,6 L6,18" />
                      </Button>
                    </StackPanel>
                  </Grid>
                </Border>
                <ToggleButton Grid.Column="3"
                              Classes="iconToggle"
                              HorizontalAlignment="Right"
                              IsChecked="{Binding SelectedProfile.IsDefault, Mode=OneWay}"
                              Command="{Binding SetDefaultCommand}"
                              ToolTip.Tip="Set as default">
                  <Path Width="14"
                        Height="14"
                        Stretch="Uniform"
                        Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.45,13.97 L5.82,21 Z" />
                </ToggleButton>
              </Grid>
              <TextBlock Text="{Binding AppLinksTitle}" Foreground="{DynamicResource TextMutedBrush}" />
              <ListBox ItemsSource="{Binding ProfileAppsEdit}"
                       SelectedItem="{Binding SelectedAppLink}">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Grid Classes="appLinkEditor">
                      <TextBox Text="{Binding Value}"
                               Padding="10,6,58,6" />
                      <StackPanel Orientation="Horizontal"
                                  HorizontalAlignment="Right"
                                  VerticalAlignment="Center"
                                  Spacing="4"
                                  Margin="0,0,6,0">
                        <Button Classes="appLinkRemove"
                                Width="22"
                                Height="22"
                                ToolTip.Tip="Strip to exe"
                                Command="{Binding DataContext.StripAppLinkCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                CommandParameter="{Binding}">
                          <Path Width="12"
                                Height="12"
                                Stretch="Uniform"
                                Fill="{DynamicResource TextMutedBrush}"
                                Data="M4,8 L8,4 L20,16 L16,20 Z M3,21 L7,17 L11,21 Z" />
                        </Button>
                        <Button Classes="appLinkRemove"
                                Width="22"
                                Height="22"
                                ToolTip.Tip="Remove app"
                                Command="{Binding DataContext.RemoveAppLinkCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                CommandParameter="{Binding}">
                          <Path Width="12"
                                Height="12"
                                Stretch="Uniform"
                                Fill="{DynamicResource TextMutedBrush}"
                                Data="M3,6 L5,6 L5,18 L19,18 L19,6 L21,6 L21,4 L16,4 L15,3 L9,3 L8,4 L3,4 Z M7,8 L9,8 L9,16 L7,16 Z M11,8 L13,8 L13,16 L11,16 Z M15,8 L17,8 L17,16 L15,16 Z" />
                        </Button>
                      </StackPanel>
                    </Grid>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
              <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBox Width="240" Text="{Binding NewAppLink}" Watermark="app.exe or full path" />
                <Button Classes="ghost" Content="Add" Command="{Binding AddAppLinkCommand}" />
                <Button Classes="ghost"
                        Content="Running apps"
                        Click="OnRunningAppsButtonClicked">
                  <Button.Flyout>
                    <Flyout Placement="Bottom">
                      <Border Classes="card" Padding="12" Width="360">
                        <StackPanel Spacing="10">
                          <TextBlock Text="Running apps" FontWeight="SemiBold" />
                          <ScrollViewer Height="260">
                            <ItemsControl ItemsSource="{Binding RunningApps}">
                              <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                  <StackPanel Spacing="6" />
                                </ItemsPanelTemplate>
                              </ItemsControl.ItemsPanel>
                              <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                  <Button Classes="ghost"
                                          Padding="10,6"
                                          HorizontalContentAlignment="Left"
                                          Command="{Binding DataContext.SelectRunningAppCommand, ElementName=RootWindow}"
                                          CommandParameter="{Binding}">
                                    <StackPanel>
                                      <TextBlock Text="{Binding TitleDisplay}"
                                                 FontWeight="SemiBold"
                                                 TextWrapping="NoWrap"
                                                 MaxWidth="320" />
                                      <TextBlock Text="{Binding ExeDisplay}"
                                                 FontSize="11"
                                                 Foreground="{DynamicResource TextMutedBrush}"
                                                 TextWrapping="NoWrap"
                                                 MaxWidth="320" />
                                    </StackPanel>
                                  </Button>
                                </DataTemplate>
                              </ItemsControl.ItemTemplate>
                            </ItemsControl>
                          </ScrollViewer>
                        </StackPanel>
                      </Border>
                    </Flyout>
                  </Button.Flyout>
                </Button>
              </StackPanel>
              
              <!-- Device Preview for Profile Colors -->
              <StackPanel Spacing="6" Margin="0,10,0,0">
                <TextBlock Text="Device Colors" FontWeight="SemiBold" />
                <Border Background="{DynamicResource SidebarBrush}"
                        CornerRadius="10"
                        Padding="20">
                  <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <Viewbox Stretch="Uniform" MaxWidth="800" MaxHeight="400">
                      <Grid Width="{Binding KeyboardCanvasWidth}"
                            Height="{Binding KeyboardCanvasHeight}">
                        <Image Source="{Binding KeyboardImage}"
                               Stretch="Uniform"
                               HorizontalAlignment="Left"
                               VerticalAlignment="Top" />
                        <ItemsControl ItemsSource="{Binding KeyButtons}">
                          <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                              <Canvas Width="{Binding DataContext.KeyboardCanvasWidth, RelativeSource={RelativeSource AncestorType=Window}}"
                                      Height="{Binding DataContext.KeyboardCanvasHeight, RelativeSource={RelativeSource AncestorType=Window}}" />
                            </ItemsPanelTemplate>
                          </ItemsControl.ItemsPanel>
                          <ItemsControl.ItemTemplate>
                            <DataTemplate>
                              <Button Width="{Binding Width}"
                                      Height="{Binding Height}"
                                      Background="{Binding FillBrush}"
                                      BorderBrush="{DynamicResource BorderBrush}"
                                      BorderThickness="1"
                                      CornerRadius="2"
                                      Padding="0"
                                      Command="{Binding DataContext.ProfileKeyClickedCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}">
                                <Canvas.Left>
                                  <Binding Path="X" />
                                </Canvas.Left>
                                <Canvas.Top>
                                  <Binding Path="Y" />
                                </Canvas.Top>
                              </Button>
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                      </Grid>
                    </Viewbox>
                  </ScrollViewer>
                </Border>
                
                <!-- Color Picker for Profile Keys -->
                <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,4,0,0">
                  <TextBlock Text="Key Color:" VerticalAlignment="Center" />
                  <TextBox Width="100"
                           Text="{Binding ProfileKeyColorHex}"
                           Watermark="#RRGGBB" />
                  <Button Classes="colorCircle" VerticalAlignment="Center">
                    <Button.Flyout>
                      <Flyout Placement="Bottom">
                        <cp:ColorView Color="{Binding ProfileKeyColor}" Width="280" Height="250" />
                      </Flyout>
                    </Button.Flyout>
                    <Border Width="22"
                            Height="22"
                            CornerRadius="11"
                            Background="{Binding ProfileKeyColorBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1" />
                  </Button>
                  <Button Classes="ghost" 
                          Content="Apply to Selected"
                          Command="{Binding ApplyProfileKeyColorCommand}" />
                  <Button Classes="ghost" 
                          Content="Clear Selection"
                          Command="{Binding ClearProfileKeySelectionCommand}" />
                </StackPanel>
              </StackPanel>
              
              <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Classes="primary" Content="Save Changes" Command="{Binding SaveProfileEditsCommand}" />
              </StackPanel>
            </StackPanel>
          </Border>
          </Grid>
        </ScrollViewer>
      </TabItem>

      <TabItem Header="Playground">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
          <StackPanel Spacing="18">
            <Border Classes="card">
              <StackPanel Spacing="10">
                <TextBlock Text="Playground" Classes="section" />
                <Grid ColumnDefinitions="150,130,130,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="10">
                  <ComboBox Grid.Row="0" Grid.Column="0"
                            ItemsSource="{Binding LightingModes}"
                            SelectedItem="{Binding SelectedLightingMode}" />
                  <ComboBox Grid.Row="0" Grid.Column="1"
                            ItemsSource="{Binding BrightnessOptions}"
                            SelectedItem="{Binding SelectedBrightness}" />
                  <ComboBox Grid.Row="0" Grid.Column="2"
                            ItemsSource="{Binding SpeedOptions}"
                            SelectedItem="{Binding SelectedSpeed}" />

                  <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10">
                    <TextBox Width="140"
                             Text="{Binding SelectedColorHex}"
                             Watermark="#RRGGBB" />
                    <Button Classes="colorCircle" VerticalAlignment="Center">
                      <Button.Flyout>
                        <Flyout Placement="Bottom">
                          <cp:ColorView Color="{Binding SelectedColor}" Width="280" Height="250" />
                        </Flyout>
                      </Button.Flyout>
                      <Border Width="22"
                              Height="22"
                              CornerRadius="11"
                              Background="{Binding SelectedColorBrush}"
                              BorderBrush="{DynamicResource BorderBrush}"
                              BorderThickness="1" />
                    </Button>
                  </StackPanel>

                  <StackPanel Grid.Row="1" Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <ToggleSwitch IsChecked="{Binding LightingRainbow}" />
                    <TextBlock Text="Rainbow" VerticalAlignment="Center" />
                  </StackPanel>

                  <Button Grid.Row="2" Grid.Column="0"
                          Classes="primary"
                          Content="Apply Lighting"
                          HorizontalAlignment="Left"
                          Command="{Binding ApplyLightingCommand}" />
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
        </ScrollViewer>
      </TabItem>
    </TabControl>

    <Border Grid.Row="2"
            Background="{DynamicResource SidebarBrush}"
            CornerRadius="12"
            Padding="10"
            Margin="0,18,0,0"
            Height="42">
      <Grid ColumnDefinitions="*,Auto" VerticalAlignment="Center">
        <Grid VerticalAlignment="Center">
          <TextBlock Foreground="{DynamicResource TextMutedBrush}"
                     VerticalAlignment="Center"
                     HorizontalAlignment="Left"
                     IsVisible="{Binding ShowActiveAppLabel}"
                     IsHitTestVisible="False"
                     FontSize="12"
                     TextAlignment="Left"
                     TextTrimming="CharacterEllipsis"
                     TextWrapping="NoWrap"
                     MaxWidth="520">
            <Run Text="Active app: " />
            <Run Text="{Binding ActiveAppDirectory}" />
            <Run Text="{Binding ActiveAppExe}" FontWeight="Bold" />
          </TextBlock>
          <StackPanel Orientation="Horizontal"
                      Spacing="10"
                      VerticalAlignment="Center"
                      IsVisible="{Binding IsSelfActiveApp}">
            <TextBlock Text="Last app:"
                       Foreground="{DynamicResource TextMutedBrush}"
                       FontSize="12"
                       VerticalAlignment="Center"
                       IsVisible="{Binding HasLastExternalApp}" />
            <TextBlock Foreground="{DynamicResource TextMutedBrush}"
                       FontSize="12"
                       VerticalAlignment="Center"
                       TextTrimming="CharacterEllipsis"
                       TextWrapping="NoWrap"
                       MaxWidth="460"
                       IsVisible="{Binding HasLastExternalApp}">
              <Run Text="{Binding LastAppDirectory}" />
              <Run Text="{Binding LastAppExe}" FontWeight="Bold" />
            </TextBlock>
            <StackPanel Orientation="Horizontal"
                        Spacing="10"
                        VerticalAlignment="Center"
                        IsVisible="{Binding HasLastExternalApp}">
              <Button Classes="ghost"
                      Content="Add full path"
                      Padding="6,2"
                      FontSize="12"
                      Height="24"
                      Command="{Binding AddLastActiveAppCommand}" />
              <Button Classes="ghost"
                      Content="Add exe only"
                      Padding="6,2"
                      FontSize="12"
                      Height="24"
                      Command="{Binding AddLastActiveAppExeCommand}" />
            </StackPanel>
          </StackPanel>
        </Grid>
        <TextBlock Grid.Column="1"
                   Text="{Binding StatusMessage}"
                   Foreground="{DynamicResource TextMutedBrush}"
                   VerticalAlignment="Center"
                   TextAlignment="Right"
                   FontSize="12" />
      </Grid>
    </Border>
  </Grid>
</Window>
