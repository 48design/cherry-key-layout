<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:cp="clr-namespace:Avalonia.Controls;assembly=Avalonia.Controls.ColorPicker"
        xmlns:assets="clr-namespace:CherryKeyLayout.Gui"
        xmlns:conv="clr-namespace:CherryKeyLayout.Gui.Converters"
        xmlns:local="clr-namespace:CherryKeyLayout.Gui.Converters"
        x:Class="CherryKeyLayout.Gui.MainWindow"
        x:Name="RootWindow"
        Title="Cherry Key Layout"
        Width="1100"
        Height="680"
        MinWidth="980"
        MinHeight="600"
        ExtendClientAreaToDecorationsHint="True">
  <Window.Resources>
    <local:BoolToThicknessConverter x:Key="BoolToThickness" />
    <local:HandleRightConverter x:Key="HandleRight" />
    <local:HandleBottomConverter x:Key="HandleBottom" />
  </Window.Resources>
  <Grid RowDefinitions="Auto,*,Auto" Margin="18">
    <Grid Height="28" ColumnDefinitions="Auto,*" Background="Transparent">
      <Button Classes="ghost"
              Width="28"
              Height="28"
              Padding="0"
              HorizontalContentAlignment="Center"
              VerticalContentAlignment="Center"
              HorizontalAlignment="Left"
              VerticalAlignment="Center">
        <Button.Flyout>
          <MenuFlyout>
            <MenuItem Header="Device" Command="{Binding SelectDeviceTabCommand}">
              <MenuItem.Icon>
                <Image Width="14"
                       Height="14"
                       Source="{Binding Source={x:Static assets:IconAssets.Keyboard}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
              </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Settings" Command="{Binding SelectSettingsTabCommand}">
              <MenuItem.Icon>
                <Image Width="14"
                       Height="14"
                       Source="{Binding Source={x:Static assets:IconAssets.Settings}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
              </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="About" Click="OnAboutClicked">
              <MenuItem.Icon>
                <Image Width="14"
                       Height="14"
                       Source="{Binding Source={x:Static assets:IconAssets.Info}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
              </MenuItem.Icon>
            </MenuItem>
          </MenuFlyout>
        </Button.Flyout>
        <Path Width="14"
              Height="12"
              Stretch="Uniform"
              HorizontalAlignment="Center"
              VerticalAlignment="Center"
              Stroke="{DynamicResource TextMutedBrush}"
              StrokeThickness="2"
              StrokeLineCap="Round"
              Data="M3,5 L21,5 M3,11 L21,11 M3,17 L21,17" />
      </Button>
      <Border Grid.Column="1"
              Background="Transparent"
              PointerPressed="OnDragPointerPressed" />
    </Grid>
    <TabControl Grid.Row="1" TabStripPlacement="Left" SelectedIndex="{Binding SelectedTabIndex}">
      <TabItem Header="Devices" Classes="menuOnlyTab">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
          <Grid ColumnDefinitions="280,*" RowDefinitions="Auto,*" Margin="0">
          <Border Classes="card" Grid.RowSpan="2">
            <StackPanel Spacing="10">
              <TextBlock Text="{Binding DeviceCountLabel}" Classes="section" />
              <ListBox ItemsSource="{Binding Devices}"
                       SelectedItem="{Binding SelectedDevice}"
                       Background="Transparent"
                       BorderThickness="0"
                       Margin="0,4,0,8">
                <ListBox.Styles>
                  <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                  </Style>
                  <Style Selector="ListBoxItem:selected">
                    <Setter Property="Background" Value="Transparent" />
                  </Style>
                  <Style Selector="ListBoxItem:pointerover Border.deviceIndicator">
                    <Setter Property="Background" Value="{DynamicResource AccentSoftBrush}" />
                  </Style>
                  <Style Selector="ListBoxItem:selected Border.deviceIndicator">
                    <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                  </Style>
                </ListBox.Styles>
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Border CornerRadius="10"
                            ClipToBounds="True"
                            Margin="6,4,6,4"
                            HorizontalAlignment="Stretch">
                      <Grid ColumnDefinitions="6,*">
                        <Border Classes="deviceIndicator"
                                Background="Transparent"
                                CornerRadius="10" />
                        <Border Grid.Column="1"
                                Padding="10"
                                Background="{DynamicResource CardBrush}"
                                CornerRadius="10">
                          <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                        </Border>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
              <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Classes="ghost" Command="{Binding AddDeviceCommand}">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Add}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Add" />
                  </StackPanel>
                </Button>
                <Button Classes="ghost" Command="{Binding RemoveDeviceCommand}">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Remove}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Remove" />
                  </StackPanel>
                </Button>
              </StackPanel>
            </StackPanel>
          </Border>

          <Border Classes="card" Grid.Column="1" Margin="18,0,0,0">
            <StackPanel Spacing="10">
              <TextBlock Text="Device Setup" Classes="section" />
              <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="Name" VerticalAlignment="Center" />
                <TextBox Width="260" Text="{Binding DeviceName}" />
                <Button Classes="ghost" Click="OnLoadKeyboardImageClicked">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Image}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Load Keyboard Image" />
                  </StackPanel>
                </Button>
                <Button Classes="ghost" Click="OnLoadKeyboardLayoutClicked">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Open}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Load Key Layout" />
                  </StackPanel>
                </Button>
                <Button Classes="ghost" Click="OnSaveKeyboardLayoutClicked" IsEnabled="{Binding IsLayoutReady}">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Save}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Save Layout" />
                  </StackPanel>
                </Button>
              </StackPanel>
              <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="Layout Template" VerticalAlignment="Center" />
                <ComboBox Width="140"
                          ItemsSource="{Binding KeyboardLayoutTemplates}"
                          SelectedItem="{Binding SelectedLayoutTemplate}" />
                <Button Classes="ghost" Command="{Binding GenerateFromTemplateCommand}">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Keyboard}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Generate from Template" />
                  </StackPanel>
                </Button>
                <TextBlock Text="or" VerticalAlignment="Center" Foreground="{DynamicResource TextMutedBrush}" />
                <TextBlock Text="Grid" VerticalAlignment="Center" />
                <TextBox Width="60" Text="{Binding LayoutColumnsText}" Watermark="Cols" />
                <TextBox Width="60" Text="{Binding LayoutRowsText}" Watermark="Rows" />
                <Button Classes="ghost" Command="{Binding GenerateLayoutCommand}">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Grid}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Generate Grid" />
                  </StackPanel>
                </Button>
                <Button Classes="ghost" Content="Add Key" Click="OnAddKeyClicked" />
                <Button Classes="ghost" Content="Map Keys" Click="OnStartKeyMappingClicked" />
              </StackPanel>
              <StackPanel Orientation="Horizontal"
                          Spacing="10"
                          IsVisible="{Binding IsMappingKeys}">
                <TextBlock Text="Mapping" VerticalAlignment="Center" Foreground="{DynamicResource TextMutedBrush}" />
                <Button Classes="ghost" Content="Skip" Click="OnMappingSkipClicked" />
                <Button Classes="ghost" Content="Back" Click="OnMappingBackClicked" />
                <Button Classes="ghost" Content="Stop" Click="OnMappingStopClicked" />
              </StackPanel>
              <StackPanel Orientation="Horizontal" Spacing="8">
                <Path Width="12"
                      Height="12"
                      Stretch="Uniform"
                      Stroke="{DynamicResource TextMutedBrush}"
                      StrokeThickness="1.5"
                      Data="M9,2 C6.8,2 5,3.8 5,6 C5,7.7 5.8,9.1 7,9.8 L7,12 C7,12.6 7.4,13 8,13 L10,13 C10.6,13 11,12.6 11,12 L11,9.8 C12.2,9.1 13,7.7 13,6 C13,3.8 11.2,2 9,2 Z M7,14 L11,14 M6,15 L12,15" />
                <TextBlock Text="Drag: move  |  Shift+Drag: lock axis  |  Alt+Drag: clone  |  Ctrl+Wheel: resize  |  Shift+Resize: lock axis  |  Del: remove  |  Ctrl+C/V: copy/paste  |  Right click: cancel drag/resize"
                           Foreground="{DynamicResource TextMutedBrush}"
                           FontSize="11"
                           TextWrapping="NoWrap" />
              </StackPanel>
            </StackPanel>
          </Border>

          <Border Classes="card" Grid.Column="1" Grid.Row="1" Margin="18,18,0,0">
            <Grid RowDefinitions="Auto,*" RowSpacing="12">
              <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <TextBlock Text="Align" VerticalAlignment="Center" Foreground="{DynamicResource TextMutedBrush}" />
                <Button Classes="ghost" Width="28" Height="28" Padding="0" ToolTip.Tip="Align left" Click="OnAlignLeftClicked">
                  <Path Width="16" Height="16" Stretch="Uniform" Stroke="{DynamicResource TextMutedBrush}" StrokeThickness="2" StrokeLineCap="Round"
                        Data="M4,3 L4,21 M7,7 L18,7 M7,12 L15,12 M7,17 L20,17" />
                </Button>
                <Button Classes="ghost" Width="28" Height="28" Padding="0" ToolTip.Tip="Align center" Click="OnAlignCenterClicked">
                  <Path Width="16" Height="16" Stretch="Uniform" Stroke="{DynamicResource TextMutedBrush}" StrokeThickness="2" StrokeLineCap="Round"
                        Data="M12,3 L12,21 M5,7 L19,7 M7,12 L17,12 M6,17 L18,17" />
                </Button>
                <Button Classes="ghost" Width="28" Height="28" Padding="0" ToolTip.Tip="Align right" Click="OnAlignRightClicked">
                  <Path Width="16" Height="16" Stretch="Uniform" Stroke="{DynamicResource TextMutedBrush}" StrokeThickness="2" StrokeLineCap="Round"
                        Data="M20,3 L20,21 M6,7 L17,7 M9,12 L17,12 M4,17 L17,17" />
                </Button>
                <Button Classes="ghost" Width="28" Height="28" Padding="0" ToolTip.Tip="Align top" Click="OnAlignTopClicked">
                  <Image Width="16"
                         Height="16"
                         Source="{Binding Source={x:Static assets:IconAssets.AlignTop}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=16}" />
                </Button>
                <Button Classes="ghost" Width="28" Height="28" Padding="0" ToolTip.Tip="Align bottom" Click="OnAlignBottomClicked">
                  <Image Width="16"
                         Height="16"
                         Source="{Binding Source={x:Static assets:IconAssets.AlignBottom}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=16}" />
                </Button>
                <Button Classes="ghost" Width="28" Height="28" Padding="0" ToolTip.Tip="Space evenly (horizontal)" Click="OnDistributeHorizontalClicked">
                  <Path Width="16" Height="16" Stretch="Uniform" Stroke="{DynamicResource TextMutedBrush}" StrokeThickness="2" StrokeLineCap="Round"
                        Data="M4,5 L4,19 M20,5 L20,19 M7,12 L10,12 M12,12 L15,12 M17,12 L17,12" />
                </Button>
                <Button Classes="ghost" Width="28" Height="28" Padding="0" ToolTip.Tip="Space evenly (vertical)" Click="OnDistributeVerticalClicked">
                  <Path Width="16" Height="16" Stretch="Uniform" Stroke="{DynamicResource TextMutedBrush}" StrokeThickness="2" StrokeLineCap="Round"
                        Data="M5,4 L19,4 M5,20 L19,20 M12,7 L12,10 M12,12 L12,15 M12,17 L12,17" />
                </Button>
                <Border Width="1" Height="18" Background="{DynamicResource TextMutedBrush}" Opacity="0.6" />
                <ToggleSwitch IsChecked="{Binding ShowKeyNames}"
                              OnContent="Show names"
                              OffContent="Show names" />
                <Border Width="1" Height="18" Background="{DynamicResource TextMutedBrush}" Opacity="0.6" />
                <Button x:Name="TrashButton" Classes="ghost" Width="28" Height="28" Padding="0" ToolTip.Tip="Trash" Click="OnTrashClicked">
                  <Image Width="14"
                         Height="14"
                         Source="{Binding Source={x:Static assets:IconAssets.Trash}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                </Button>
              </StackPanel>
              <Viewbox x:Name="KeyboardViewbox"
                       Grid.Row="1"
                       Stretch="Uniform"
                       StretchDirection="Both"
                       HorizontalAlignment="Stretch"
                       VerticalAlignment="Stretch">
                  <Grid Width="{Binding KeyboardCanvasWidth}" Height="{Binding KeyboardCanvasHeight}">
                    <Image Source="{Binding KeyboardImage}"
                           Width="{Binding KeyboardCanvasWidth}"
                           Height="{Binding KeyboardCanvasHeight}"
                           Stretch="Uniform" />
                    <ItemsControl x:Name="KeyboardKeys"
                                  ItemsSource="{Binding KeyButtons}"
                                  Width="{Binding KeyboardCanvasWidth}"
                                  Height="{Binding KeyboardCanvasHeight}">
                      <ItemsControl.Styles>
                        <Style Selector="ItemsControl#KeyboardKeys > ContentPresenter">
                          <Setter Property="Canvas.Left" Value="{Binding X}" />
                          <Setter Property="Canvas.Top" Value="{Binding Y}" />
                        </Style>
                      </ItemsControl.Styles>
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <Canvas Background="Transparent" ClipToBounds="True" />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Grid Width="{Binding Width}"
                                Height="{Binding Height}"
                                PointerEntered="OnKeyPointerEntered"
                                PointerExited="OnKeyPointerExited">
                            <Grid.ContextMenu>
                              <ContextMenu>
                                <MenuItem Header="Copy" Click="OnKeyCopyClicked" />
                                <MenuItem Header="Paste" Click="OnKeyPasteClicked" />
                                <MenuItem Header="Set key name" Click="OnKeyRenameClicked" />
                                <MenuItem Header="Set key name (manual)" Click="OnKeyRenameManualClicked" />
                                <MenuItem Header="Remap key..." Click="OnKeyRemapClicked" />
                                <MenuItem Header="Delete" Click="OnKeyDeleteClicked" />
                              </ContextMenu>
                            </Grid.ContextMenu>
                            <!-- Key background -->
                            <Border Width="{Binding Width}"
                              Height="{Binding Height}"
                              Classes="keyBackground"
                              Background="#40FFFFFF"
                              BorderBrush="#80FFFFFF"
                              BorderThickness="1"
                              CornerRadius="2"
                              ToolTip.Tip="{Binding Id}"
                              Cursor="Hand" />
                            <Border Width="{Binding Width}"
                              Height="{Binding Height}"
                              BorderBrush="#FF2E2E"
                              BorderThickness="2"
                              CornerRadius="2"
                              IsVisible="{Binding IsMappingHighlight}"
                              IsHitTestVisible="False" />
                            <Border Width="{Binding Width}"
                              Height="{Binding Height}"
                              Background="#40FF2E2E"
                              CornerRadius="2"
                              IsVisible="{Binding IsMappedKey}"
                              IsHitTestVisible="False" />
                            <Border Width="{Binding Width}"
                              Height="{Binding Height}"
                              Classes="keyHoverOverlay"
                              Background="#BFFFFFFF"
                              CornerRadius="2"
                              IsVisible="{Binding IsHovering}"
                              IsHitTestVisible="False" />
                            <TextBlock Text="{Binding Id}"
                                       IsVisible="{Binding DataContext.ShowKeyNames, RelativeSource={RelativeSource AncestorType=Window}}"
                                       Foreground="{DynamicResource TextMutedBrush}"
                                       FontSize="10"
                                       TextAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       MaxWidth="{Binding Width}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       IsHitTestVisible="False" />
                            <!-- Selection overlay -->
                            <Border Width="{Binding Width}"
                              Height="{Binding Height}"
                              BorderBrush="#FF00BFFF"
                              BorderThickness="{Binding IsSelected, Converter={StaticResource BoolToThickness}, ConverterParameter=2}"
                              CornerRadius="2"
                              IsHitTestVisible="False" />
                            <!-- Resize handles (corners) -->
                            <Canvas Width="{Binding Width}" Height="{Binding Height}">
                              <Rectangle Width="8" Height="8" Fill="#FF00BFFF" Cursor="SizeAll"
                                   Canvas.Left="-4" Canvas.Top="-4"
                                   IsVisible="{Binding ShowResizeHandles}"
                                   Tag="TopLeft"
                                   PointerPressed="OnResizeHandlePointerPressed" />
                              <Rectangle Width="8" Height="8" Fill="#FF00BFFF" Cursor="SizeAll"
                                   Canvas.Left="{Binding Width, Converter={StaticResource HandleRight}}" Canvas.Top="-4"
                                   IsVisible="{Binding ShowResizeHandles}"
                                   Tag="TopRight"
                                   PointerPressed="OnResizeHandlePointerPressed" />
                              <Rectangle Width="8" Height="8" Fill="#FF00BFFF" Cursor="SizeAll"
                                   Canvas.Left="-4" Canvas.Top="{Binding Height, Converter={StaticResource HandleBottom}}"
                                   IsVisible="{Binding ShowResizeHandles}"
                                   Tag="BottomLeft"
                                   PointerPressed="OnResizeHandlePointerPressed" />
                              <Rectangle Width="8" Height="8" Fill="#FF00BFFF" Cursor="SizeAll"
                                   Canvas.Left="{Binding Width, Converter={StaticResource HandleRight}}" Canvas.Top="{Binding Height, Converter={StaticResource HandleBottom}}"
                                   IsVisible="{Binding ShowResizeHandles}"
                                   Tag="BottomRight"
                                   PointerPressed="OnResizeHandlePointerPressed" />
                            </Canvas>
                          </Grid>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <Canvas Width="{Binding KeyboardCanvasWidth}"
                            Height="{Binding KeyboardCanvasHeight}"
                            IsHitTestVisible="False">
                      <Border x:Name="DeviceMarquee"
                              BorderBrush="#80FFFFFF"
                              Background="#30FFFFFF"
                              BorderThickness="1"
                              CornerRadius="2"
                              IsVisible="False" />
                    </Canvas>
                    <Canvas Width="{Binding KeyboardCanvasWidth}"
                            Height="{Binding KeyboardCanvasHeight}">
                      <Border x:Name="SelectionOutline"
                              BorderBrush="#FF00BFFF"
                              BorderThickness="1"
                              CornerRadius="2"
                              Background="Transparent"
                            IsVisible="False"
                            IsHitTestVisible="False" />
                      <Rectangle x:Name="SelectionHandleTopLeft"
                               Width="8"
                               Height="8"
                               Fill="#FF00BFFF"
                               Cursor="SizeAll"
                               Tag="TopLeft"
                               IsVisible="False"
                               PointerPressed="OnSelectionHandlePointerPressed" />
                    <Rectangle x:Name="SelectionHandleTopRight"
                               Width="8"
                               Height="8"
                               Fill="#FF00BFFF"
                               Cursor="SizeAll"
                               Tag="TopRight"
                               IsVisible="False"
                               PointerPressed="OnSelectionHandlePointerPressed" />
                    <Rectangle x:Name="SelectionHandleBottomLeft"
                               Width="8"
                               Height="8"
                               Fill="#FF00BFFF"
                               Cursor="SizeAll"
                               Tag="BottomLeft"
                               IsVisible="False"
                               PointerPressed="OnSelectionHandlePointerPressed" />
                    <Rectangle x:Name="SelectionHandleBottomRight"
                               Width="8"
                               Height="8"
                               Fill="#FF00BFFF"
                               Cursor="SizeAll"
                               Tag="BottomRight"
                               IsVisible="False"
                               PointerPressed="OnSelectionHandlePointerPressed" />
                    <Border Background="#CC1F1F1F"
                            CornerRadius="6"
                            Padding="10"
                            IsVisible="{Binding IsRenamingKey}"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Margin="10"
                            IsHitTestVisible="False">
                      <TextBlock Text="{Binding RenamePrompt}"
                                 Foreground="White"
                                 FontSize="12"
                                 TextWrapping="Wrap"
                                 MaxWidth="280" />
                    </Border>
                    <Border Background="#CC1F1F1F"
                            CornerRadius="6"
                            Padding="10"
                            IsVisible="{Binding IsMappingKeys}"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Margin="10,64,10,10"
                            IsHitTestVisible="False">
                      <TextBlock Text="{Binding MappingPrompt}"
                                 Foreground="White"
                                 FontSize="12"
                                 TextWrapping="Wrap"
                                 MaxWidth="320" />
                    </Border>
                  </Canvas>
                </Grid>
              </Viewbox>
            </Grid>
          </Border>
          </Grid>
        </ScrollViewer>
      </TabItem>

      <TabItem Header="Settings" Classes="menuOnlyTab">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
          <StackPanel Spacing="18">
            <Border Classes="card">
              <StackPanel Spacing="10">
                <TextBlock Text="Settings Load / Save" Classes="section" />
                <TextBox Text="{Binding SettingsPath}" Watermark="Path to settings.json" />
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <Button Classes="ghost" Content="Browse" Click="OnBrowseClicked" />
                  <Button Classes="ghost" Content="Reload" Command="{Binding ReloadCommand}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <ToggleSwitch IsChecked="{Binding SyncSelectedProfile}"
                                OnContent="Sync selected profile to file"
                                OffContent="Sync selected profile to file" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <ToggleSwitch IsChecked="{Binding RunOnSystemStart}"
                                OnContent="Run on system start"
                                OffContent="Run on system start" />
                  <TextBlock Text="Delay (in seconds):" Margin="16,0,0,0" VerticalAlignment="Center" />
                  <NumericUpDown Minimum="0"
                                 Maximum="120"
                                 Width="110"
                                 MinWidth="90"
                                 Value="{Binding StartupDelaySeconds, Mode=TwoWay}" />
                </StackPanel>
              </StackPanel>
            </Border>
            <Border Classes="card">
              <StackPanel Spacing="10">
                <TextBlock Text="Screen Saver" Classes="section" />
                <ToggleSwitch IsChecked="{Binding ScreenSaverEnabled}"
                              OnContent="Screen saver lighting"
                              OffContent="Screen saver lighting" />
                <TextBlock Text="Used while the screen saver is running, the session is locked, or the display is off."
                           Foreground="{DynamicResource TextMutedBrush}" />
                <Grid ColumnDefinitions="150,130,130,*"
                      RowDefinitions="Auto,Auto,Auto"
                      ColumnSpacing="10"
                      RowSpacing="10"
                      IsVisible="{Binding ScreenSaverEnabled}">
                  <ComboBox Grid.Row="0" Grid.Column="0"
                            ItemsSource="{Binding ScreenSaverLightingModes}"
                            SelectedItem="{Binding ScreenSaverMode}" />
                  <ComboBox Grid.Row="0" Grid.Column="1"
                            ItemsSource="{Binding BrightnessOptions}"
                            SelectedItem="{Binding ScreenSaverBrightness}" />
                  <ComboBox Grid.Row="0" Grid.Column="2"
                            ItemsSource="{Binding SpeedOptions}"
                            SelectedItem="{Binding ScreenSaverSpeed}" />

                  <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10">
                    <TextBox Width="140"
                             Text="{Binding ScreenSaverColorHex}"
                             Watermark="#RRGGBB" />
                    <Button Classes="colorCircle" VerticalAlignment="Center">
                      <Button.Flyout>
                        <Flyout Placement="Bottom">
                          <cp:ColorView Color="{Binding ScreenSaverColor}" Width="280" Height="250" />
                        </Flyout>
                      </Button.Flyout>
                      <Border Width="22"
                              Height="22"
                              CornerRadius="11"
                              Background="{Binding ScreenSaverColorBrush}"
                              BorderBrush="{DynamicResource BorderBrush}"
                              BorderThickness="1" />
                    </Button>
                  </StackPanel>

                  <StackPanel Grid.Row="1" Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <ToggleSwitch IsChecked="{Binding ScreenSaverRainbow}"
                                  OnContent="Rainbow"
                                  OffContent="Rainbow" />
                  </StackPanel>
                  <Button Grid.Row="2"
                          Grid.Column="0"
                          Grid.ColumnSpan="2"
                          Classes="ghost"
                          Content="Preview"
                          Command="{Binding PreviewScreenSaverCommand}" />
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

      <TabItem Header="Profiles">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
          <Grid ColumnDefinitions="280,*">
            <Border Classes="card">
            <StackPanel Spacing="10">
              <TextBlock Text="{Binding ProfileCountLabel}" Classes="section" />
              <ListBox ItemsSource="{Binding Profiles}"
                       SelectedItem="{Binding SelectedProfile}"
                       Background="Transparent"
                       BorderThickness="0"
                       Margin="0,4,0,8">
                <ListBox.Styles>
                  <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                  </Style>
                  <Style Selector="ListBoxItem:selected">
                    <Setter Property="Background" Value="Transparent" />
                  </Style>
                  <Style Selector="ListBoxItem:pointerover Border.profileIndicator">
                    <Setter Property="Background" Value="{DynamicResource AccentSoftBrush}" />
                  </Style>
                  <Style Selector="ListBoxItem:selected Border.profileIndicator">
                    <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                  </Style>
                </ListBox.Styles>
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Border CornerRadius="10"
                            ClipToBounds="True"
                            Margin="6,4,6,4"
                            HorizontalAlignment="Stretch">
                      <Grid ColumnDefinitions="6,*">
                        <Border Classes="profileIndicator"
                                Background="Transparent"
                                CornerRadius="10" />
                        <Border Grid.Column="1"
                                Padding="10"
                                Background="{DynamicResource CardBrush}"
                                CornerRadius="10">
                          <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <StackPanel Spacing="4">
                              <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                                <Path Width="12"
                                      Height="12"
                                      Stretch="Uniform"
                                      Fill="{DynamicResource AccentBrush}"
                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.45,13.97 L5.82,21 Z"
                                      IsVisible="{Binding IsDefault}" />
                              </StackPanel>
                              <TextBlock Text="{Binding AppSummary}"
                                         Foreground="{DynamicResource TextMutedBrush}"
                                         FontSize="12" />
                            </StackPanel>
                              <Border Grid.Column="1"
                                      Width="36"
                                      Height="36"
                                      CornerRadius="18"
                                      Background="{DynamicResource SidebarBrush}"
                                      BorderBrush="{DynamicResource BorderBrush}"
                                      BorderThickness="1"
                                      Padding="6"
                                      ClipToBounds="True"
                                      IsVisible="{Binding HasProfileImage}">
                                <Image Width="24"
                                       Height="24"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Stretch="UniformToFill"
                                       Source="{Binding ProfileImage}" />
                              </Border>
                          </Grid>
                        </Border>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
              <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Classes="ghost" Command="{Binding AddProfileCommand}">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Add}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Add" />
                  </StackPanel>
                </Button>
                <Button Classes="ghost" Command="{Binding RemoveProfileCommand}">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <Image Width="14"
                           Height="14"
                           Source="{Binding Source={x:Static assets:IconAssets.Remove}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                    <TextBlock Text="Remove" />
                  </StackPanel>
                </Button>
              </StackPanel>
            </StackPanel>
          </Border>

            <Border Grid.Column="1" Classes="card" Margin="18,0,0,0">
            <StackPanel Spacing="10">
              <Grid ColumnDefinitions="240,64,*,Auto" VerticalAlignment="Center">
                <TextBox Grid.Column="0"
                         Text="{Binding ProfileTitleDraft}"
                         VerticalAlignment="Center"
                         Width="240"
                         HorizontalAlignment="Left"
                         IsVisible="{Binding IsEditingProfileTitle}" />
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            Spacing="6"
                            VerticalAlignment="Center"
                            IsVisible="{Binding IsNotEditingProfileTitle}">
                  <Button x:Name="ProfileIconPickerButton"
                          Classes="iconButton"
                          Width="36"
                          Height="36"
                          Padding="0"
                          IsVisible="{Binding HasProfileIconOptions}"
                          Click="OnProfileIconPickerClicked">
                    <FlyoutBase.AttachedFlyout>
                      <Flyout Placement="Bottom">
                        <Border Classes="card" Padding="10">
                          <ItemsControl ItemsSource="{Binding ProfileIconOptions}">
                            <ItemsControl.ItemsPanel>
                              <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="6" />
                              </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                              <DataTemplate>
                                <ToggleButton Classes="iconToggle"
                                              Width="44"
                                              Height="44"
                                              Padding="0"
                                              IsChecked="{Binding IsSelected, Mode=OneWay}"
                                              ToolTip.Tip="{Binding ToolTip}"
                                              Click="OnProfileIconPicked">
                                  <Border Width="36"
                                          Height="36"
                                          CornerRadius="18"
                                          Background="{DynamicResource SidebarBrush}"
                                          BorderBrush="{DynamicResource BorderBrush}"
                                          BorderThickness="1"
                                          Padding="6"
                                          ClipToBounds="True">
                                    <Grid>
                                      <Image Width="24"
                                             Height="24"
                                             HorizontalAlignment="Center"
                                             VerticalAlignment="Center"
                                             Stretch="UniformToFill"
                                              Source="{Binding Icon}"
                                              IsVisible="{Binding HasIcon}" />
                                      <Image Width="18"
                                             Height="18"
                                             HorizontalAlignment="Center"
                                             VerticalAlignment="Center"
                                             Source="{Binding Source={x:Static assets:IconAssets.None}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=18}"
                                             IsVisible="{Binding IsNone}" />
                                    </Grid>
                                  </Border>
                                </ToggleButton>
                              </DataTemplate>
                            </ItemsControl.ItemTemplate>
                          </ItemsControl>
                        </Border>
                      </Flyout>
                    </FlyoutBase.AttachedFlyout>
                    <Border Width="30"
                            Height="30"
                            CornerRadius="15"
                            Background="{DynamicResource SidebarBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            Padding="5"
                            ClipToBounds="True">
                      <Image Width="20"
                             Height="20"
                             HorizontalAlignment="Center"
                             VerticalAlignment="Center"
                             Stretch="UniformToFill"
                             Source="{Binding SelectedProfile.ProfileImage}"
                             IsVisible="{Binding SelectedProfile.HasProfileImage}" />
                    </Border>
                  </Button>
                  <TextBlock Text="{Binding SelectedProfileTitle}"
                             FontSize="18"
                             FontWeight="SemiBold"
                             TextTrimming="CharacterEllipsis"
                             MaxWidth="210"
                             VerticalAlignment="Center" />
                  <Button Classes="ghost"
                          Width="26"
                          Height="26"
                          Padding="0"
                          ToolTip.Tip="Edit profile name"
                          Command="{Binding StartEditProfileTitleCommand}">
                    <Path Width="14"
                          Height="14"
                          Stretch="Uniform"
                          Fill="{DynamicResource TextMutedBrush}"
                          Data="M3,17.25 L3,21 L6.75,21 L17.81,9.94 L14.06,6.19 Z M20.71,7.04 C21.1,6.65 21.1,6.02 20.71,5.63 L18.37,3.29 C17.98,2.9 17.35,2.9 16.96,3.29 L15.13,5.12 L18.88,8.87 Z" />
                  </Button>
                </StackPanel>
                <Border Grid.Column="1"
                        Width="64"
                        VerticalAlignment="Center">
                  <Grid>
                    <StackPanel Orientation="Horizontal"
                                Spacing="6"
                                HorizontalAlignment="Left"
                                IsVisible="{Binding IsEditingProfileTitle}">
                      <Button Classes="ghost"
                              Width="26"
                              Height="26"
                              Padding="0"
                              ToolTip.Tip="Confirm"
                              Command="{Binding ConfirmEditProfileTitleCommand}">
                        <Path Width="14"
                              Height="14"
                              Stretch="Uniform"
                              Fill="{DynamicResource TextMutedBrush}"
                              Data="M6,12 L10,16 L18,8 L16.6,6.6 L10,13.2 L7.4,10.6 Z" />
                      </Button>
                      <Button Classes="ghost"
                              Width="26"
                              Height="26"
                              Padding="0"
                              ToolTip.Tip="Cancel"
                              Command="{Binding CancelEditProfileTitleCommand}">
                        <Path Width="12"
                              Height="12"
                              Stretch="Uniform"
                              Stroke="{DynamicResource TextMutedBrush}"
                              StrokeThickness="2"
                              Data="M6,6 L18,18 M18,6 L6,18" />
                      </Button>
                    </StackPanel>
                  </Grid>
                </Border>
                <ToggleButton Grid.Column="3"
                              Classes="iconToggle"
                              HorizontalAlignment="Right"
                              IsChecked="{Binding SelectedProfile.IsDefault, Mode=OneWay}"
                              Command="{Binding SetDefaultCommand}"
                              ToolTip.Tip="Set as default">
                  <Path Width="14"
                        Height="14"
                        Stretch="Uniform"
                        Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.45,13.97 L5.82,21 Z" />
                </ToggleButton>
              </Grid>
              <TextBlock Text="{Binding AppLinksTitle}" Foreground="{DynamicResource TextMutedBrush}" />
              <ListBox ItemsSource="{Binding ProfileAppsEdit}"
                       SelectedItem="{Binding SelectedAppLink}">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Grid Classes="appLinkEditor"
                          ColumnDefinitions="*,Auto"
                          ColumnSpacing="8"
                          Background="Transparent">
                      <Grid>
                        <TextBox Text="{Binding Value}"
                                 Padding="32,6,10,6" />
                        <Border Width="18"
                                Height="18"
                                Margin="8,0,0,0"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Left"
                                CornerRadius="9"
                                Background="{DynamicResource SidebarBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                IsVisible="{Binding HasIcon}"
                                IsHitTestVisible="False">
                          <Image Width="12"
                                 Height="12"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"
                                 Stretch="UniformToFill"
                                 Source="{Binding Icon}" />
                        </Border>
                      </Grid>
                      <StackPanel Grid.Column="1"
                                  Orientation="Horizontal"
                                  HorizontalAlignment="Right"
                                  VerticalAlignment="Center"
                                  Spacing="4"
                                  Margin="0,0,6,0">
                        <Button Classes="appLinkRemove"
                                Width="22"
                                Height="22"
                                ToolTip.Tip="Strip to exe"
                                Command="{Binding DataContext.StripAppLinkCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                CommandParameter="{Binding}">
                          <Image Width="12"
                                 Height="12"
                                 Source="{Binding Source={x:Static assets:IconAssets.Erase}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=12}" />
                        </Button>
                        <Button Classes="appLinkRemove"
                                Width="22"
                                Height="22"
                                ToolTip.Tip="Remove app"
                                Command="{Binding DataContext.RemoveAppLinkCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                CommandParameter="{Binding}">
                          <Image Width="12"
                                 Height="12"
                                 Source="{Binding Source={x:Static assets:IconAssets.Trash}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=12}" />
                        </Button>
                      </StackPanel>
                    </Grid>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
              <StackPanel Orientation="Horizontal" Spacing="10">
                  <TextBox Width="240" Text="{Binding NewAppLink}" Watermark="app.exe or full path" />
                  <Button Classes="ghost" Content="Add" Command="{Binding AddAppLinkCommand}" />
                  <Button Classes="ghost"
                          Click="OnRunningAppsButtonClicked">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                      <Image Width="14"
                             Height="14"
                             Source="{Binding Source={x:Static assets:IconAssets.Tasks}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=14}" />
                      <TextBlock Text="Running apps" />
                    </StackPanel>
                    <Button.Flyout>
                    <Flyout Placement="Bottom">
                      <Border Classes="card" Padding="12" Width="360">
                        <StackPanel Spacing="10">
                          <TextBlock Text="Running apps" FontWeight="SemiBold" />
                          <ScrollViewer Height="260">
                            <ItemsControl ItemsSource="{Binding RunningApps}">
                              <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                  <StackPanel Spacing="6" />
                                </ItemsPanelTemplate>
                              </ItemsControl.ItemsPanel>
                              <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                  <Button Classes="ghost"
                                          Padding="10,6"
                                          HorizontalContentAlignment="Left"
                                          Command="{Binding DataContext.SelectRunningAppCommand, ElementName=RootWindow}"
                                          CommandParameter="{Binding}">
                                    <StackPanel>
                                      <TextBlock Text="{Binding TitleDisplay}"
                                                 FontWeight="SemiBold"
                                                 TextWrapping="NoWrap"
                                                 MaxWidth="320" />
                                      <TextBlock Text="{Binding ExeDisplay}"
                                                 FontSize="11"
                                                 Foreground="{DynamicResource TextMutedBrush}"
                                                 TextWrapping="NoWrap"
                                                 MaxWidth="320" />
                                    </StackPanel>
                                  </Button>
                                </DataTemplate>
                              </ItemsControl.ItemTemplate>
                            </ItemsControl>
                          </ScrollViewer>
                        </StackPanel>
                      </Border>
                    </Flyout>
                  </Button.Flyout>
                </Button>
              </StackPanel>
              
              <!-- Device Preview for Profile Colors -->
              <StackPanel Spacing="6" Margin="0,10,0,0">
                <Grid ColumnDefinitions="*,Auto" VerticalAlignment="Center">
                  <TextBlock Text="Device Colors" FontWeight="SemiBold" />
                  <ComboBox Grid.Column="1"
                            Width="200"
                            IsVisible="{Binding ShowDeviceSelector}"
                            ItemsSource="{Binding Devices}"
                            SelectedItem="{Binding SelectedDevice}"
                            DisplayMemberBinding="{Binding Name}" />
                </Grid>
                <Border Background="{DynamicResource SidebarBrush}"
                        CornerRadius="10"
                        Padding="20">
                  <Grid RowDefinitions="Auto,*" RowSpacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                      <TextBlock Text="Key Color:" VerticalAlignment="Center" />
                      <TextBox Width="100"
                               Text="{Binding ProfileKeyColorHex}"
                               Watermark="#RRGGBB" />
                      <Button Classes="colorCircle" VerticalAlignment="Center">
                        <Button.Flyout>
                          <Flyout Placement="Bottom">
                            <cp:ColorView Color="{Binding ProfileKeyColor}" Width="280" Height="250" />
                          </Flyout>
                        </Button.Flyout>
                        <Border Width="22"
                                Height="22"
                                CornerRadius="11"
                                Background="{Binding ProfileKeyColorBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1" />
                      </Button>
                      <ToggleButton Classes="iconToggle"
                                    ToolTip.Tip="Pick color from key"
                                    IsChecked="{Binding IsProfilePickMode}">
                        <Image Width="16"
                               Height="16"
                               Source="{Binding Source={x:Static assets:IconAssets.PickColor}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=16}" />
                      </ToggleButton>
                      <ToggleButton Classes="iconToggle"
                                    ToolTip.Tip="Paint keys on click"
                                    IsChecked="{Binding IsProfilePaintMode}">
                        <Image Width="16"
                               Height="16"
                               Source="{Binding Source={x:Static assets:IconAssets.PaintBrush}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=16}" />
                      </ToggleButton>
                      <Button Classes="iconButton"
                              ToolTip.Tip="Apply color to selected keys"
                              Command="{Binding ApplyProfileKeyColorCommand}">
                        <Image Width="16"
                               Height="16"
                               Source="{Binding Source={x:Static assets:IconAssets.PaintSprayer}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=16}" />
                      </Button>
                      <Button Classes="iconButton"
                              ToolTip.Tip="Clear selection"
                              Command="{Binding ClearProfileKeySelectionCommand}">
                        <Image Width="16"
                               Height="16"
                               Source="{Binding Source={x:Static assets:IconAssets.SelectNone}, Converter={StaticResource SvgAssetToBitmap}, ConverterParameter=16}" />
                      </Button>
                    </StackPanel>
                    <Viewbox x:Name="ProfileViewbox"
                             Grid.Row="1"
                             Stretch="Uniform"
                             StretchDirection="Both"
                             HorizontalAlignment="Stretch"
                             VerticalAlignment="Stretch">
                        <Grid Width="{Binding KeyboardCanvasWidth}"
                              Height="{Binding KeyboardCanvasHeight}">
                          <Image Source="{Binding KeyboardImage}"
                                 Width="{Binding KeyboardCanvasWidth}"
                                 Height="{Binding KeyboardCanvasHeight}"
                                 Stretch="Uniform"
                                 HorizontalAlignment="Left"
                                 VerticalAlignment="Top" />
                          <ItemsControl x:Name="ProfileKeys"
                                        ItemsSource="{Binding KeyButtons}"
                                        Width="{Binding KeyboardCanvasWidth}"
                                        Height="{Binding KeyboardCanvasHeight}">
                            <ItemsControl.Styles>
                              <Style Selector="ItemsControl#ProfileKeys > ContentPresenter">
                                <Setter Property="Canvas.Left" Value="{Binding X}" />
                                <Setter Property="Canvas.Top" Value="{Binding Y}" />
                              </Style>
                            </ItemsControl.Styles>
                            <ItemsControl.ItemsPanel>
                              <ItemsPanelTemplate>
                                <Canvas Width="{Binding DataContext.KeyboardCanvasWidth, RelativeSource={RelativeSource AncestorType=Window}}"
                                        Height="{Binding DataContext.KeyboardCanvasHeight, RelativeSource={RelativeSource AncestorType=Window}}" />
                              </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                              <DataTemplate>
                                <Button Width="{Binding Width}"
                                        Height="{Binding Height}"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        CornerRadius="2"
                                        Padding="0"
                                        Cursor="{Binding DataContext.ProfileKeyCursor, RelativeSource={RelativeSource AncestorType=Window}}"
                                        PointerEntered="OnProfileKeyPointerEntered"
                                        PointerExited="OnProfileKeyPointerExited"
                                        Command="{Binding DataContext.ProfileKeyClickedCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}">
                                  <Grid>
                                    <Border Width="{Binding Width}"
                                            Height="{Binding Height}"
                                            Background="{Binding FillBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="2" />
                                    <Border Width="{Binding Width}"
                                            Height="{Binding Height}"
                                            Background="#80FFFFFF"
                                            CornerRadius="2"
                                            IsVisible="{Binding IsHovering}"
                                            IsHitTestVisible="False" />
                                    <Border Width="{Binding Width}"
                                            Height="{Binding Height}"
                                            BorderBrush="#FF00BFFF"
                                            BorderThickness="{Binding IsSelected, Converter={StaticResource BoolToThickness}, ConverterParameter=2}"
                                            CornerRadius="2"
                                            IsHitTestVisible="False" />
                                  </Grid>
                                </Button>
                              </DataTemplate>
                            </ItemsControl.ItemTemplate>
                          </ItemsControl>
                          <Canvas Width="{Binding KeyboardCanvasWidth}"
                                  Height="{Binding KeyboardCanvasHeight}"
                                  IsHitTestVisible="False">
                          <Border x:Name="ProfileMarquee"
                                  BorderBrush="#80FFFFFF"
                                  Background="#30FFFFFF"
                                  BorderThickness="1"
                                  CornerRadius="2"
                                  IsVisible="False" />
                        </Canvas>
                      </Grid>
                    </Viewbox>
                  </Grid>
                </Border>
                
                <!-- Color picker moved into toolbar above the preview -->
              </StackPanel>
              
              <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Classes="primary" Content="Save Changes" Command="{Binding SaveProfileEditsCommand}" />
              </StackPanel>
            </StackPanel>
          </Border>
          </Grid>
        </ScrollViewer>
      </TabItem>

      <TabItem Header="Playground">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
          <StackPanel Spacing="18">
            <Border Classes="card">
              <StackPanel Spacing="10">
                <TextBlock Text="Playground" Classes="section" />
                <Grid ColumnDefinitions="150,130,130,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="10">
                  <ComboBox Grid.Row="0" Grid.Column="0"
                            ItemsSource="{Binding LightingModes}"
                            SelectedItem="{Binding SelectedLightingMode}" />
                  <ComboBox Grid.Row="0" Grid.Column="1"
                            ItemsSource="{Binding BrightnessOptions}"
                            SelectedItem="{Binding SelectedBrightness}" />
                  <ComboBox Grid.Row="0" Grid.Column="2"
                            ItemsSource="{Binding SpeedOptions}"
                            SelectedItem="{Binding SelectedSpeed}" />

                  <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10">
                    <TextBox Width="140"
                             Text="{Binding SelectedColorHex}"
                             Watermark="#RRGGBB" />
                    <Button Classes="colorCircle" VerticalAlignment="Center">
                      <Button.Flyout>
                        <Flyout Placement="Bottom">
                          <cp:ColorView Color="{Binding SelectedColor}" Width="280" Height="250" />
                        </Flyout>
                      </Button.Flyout>
                      <Border Width="22"
                              Height="22"
                              CornerRadius="11"
                              Background="{Binding SelectedColorBrush}"
                              BorderBrush="{DynamicResource BorderBrush}"
                              BorderThickness="1" />
                    </Button>
                  </StackPanel>

                  <StackPanel Grid.Row="1" Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <ToggleSwitch IsChecked="{Binding LightingRainbow}"
                                  OnContent="Rainbow"
                                  OffContent="Rainbow" />
                  </StackPanel>

                  <Button Grid.Row="2" Grid.Column="0"
                          Classes="primary"
                          Content="Apply Lighting"
                          HorizontalAlignment="Left"
                          Command="{Binding ApplyLightingCommand}" />
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>
        </ScrollViewer>
      </TabItem>
    </TabControl>

    <Border Grid.Row="2"
            Background="{DynamicResource SidebarBrush}"
            CornerRadius="12"
            Padding="10"
            Margin="0,18,0,0"
            Height="42">
      <Grid ColumnDefinitions="*,Auto" VerticalAlignment="Center">
        <Grid VerticalAlignment="Center">
          <TextBlock Foreground="{DynamicResource TextMutedBrush}"
                     VerticalAlignment="Center"
                     HorizontalAlignment="Left"
                     IsVisible="{Binding ShowActiveAppLabel}"
                     IsHitTestVisible="False"
                     FontSize="12"
                     TextAlignment="Left"
                     TextTrimming="CharacterEllipsis"
                     TextWrapping="NoWrap"
                     MaxWidth="520">
            <Run Text="Active app: " />
            <Run Text="{Binding ActiveAppDirectory}" />
            <Run Text="{Binding ActiveAppExe}" FontWeight="Bold" />
          </TextBlock>
          <StackPanel Orientation="Horizontal"
                      Spacing="10"
                      VerticalAlignment="Center"
                      IsVisible="{Binding IsSelfActiveApp}">
            <TextBlock Text="Last app:"
                       Foreground="{DynamicResource TextMutedBrush}"
                       FontSize="12"
                       VerticalAlignment="Center"
                       IsVisible="{Binding HasLastExternalApp}" />
            <TextBlock Foreground="{DynamicResource TextMutedBrush}"
                       FontSize="12"
                       VerticalAlignment="Center"
                       TextTrimming="CharacterEllipsis"
                       TextWrapping="NoWrap"
                       MaxWidth="460"
                       IsVisible="{Binding HasLastExternalApp}">
              <Run Text="{Binding LastAppDirectory}" />
              <Run Text="{Binding LastAppExe}" FontWeight="Bold" />
            </TextBlock>
            <StackPanel Orientation="Horizontal"
                        Spacing="10"
                        VerticalAlignment="Center"
                        IsVisible="{Binding HasLastExternalApp}">
              <Button Classes="ghost"
                      Content="Add full path"
                      Padding="6,2"
                      FontSize="12"
                      Height="24"
                      Command="{Binding AddLastActiveAppCommand}" />
              <Button Classes="ghost"
                      Content="Add exe only"
                      Padding="6,2"
                      FontSize="12"
                      Height="24"
                      Command="{Binding AddLastActiveAppExeCommand}" />
            </StackPanel>
          </StackPanel>
        </Grid>
        <TextBlock Grid.Column="1"
                   Text="{Binding StatusMessage}"
                   Foreground="{DynamicResource TextMutedBrush}"
                   VerticalAlignment="Center"
                   TextAlignment="Right"
                   FontSize="12" />
      </Grid>
    </Border>
  </Grid>
</Window>
